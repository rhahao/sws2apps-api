# Scheduling Workbox System (sws2apps) API

[![CD](https://github.com/sws2apps/sws2apps-api/actions/workflows/deploy.yml/badge.svg)](https://github.com/sws2apps/sws2apps-api/actions/workflows/deploy.yml)

Backend service for the `sws2apps` suite of client applications, providing robust data synchronization, authentication, and performance features.

## Overview

This project is the backend API for `sws2apps`, built with Node.js, Express, and TypeScript. It provides essential services such as secure data storage (AWS S3 compatible), user authentication via Firebase, and optimized data synchronization mechanisms.

## Key Features

-   **Data Synchronization (Smart Sync)**: Property-level synchronization with conflict resolution based on `updatedAt` timestamps. Includes rollback-safe persistence and direct updates for server-managed fields.
-   **Security**: Firebase token verification for all protected routes and schema-driven request validation using Zod.
-   **Performance**: Concurrent indexing, payload optimization via compression, and strict payload size limits.
-   **Maintenance & Health**: Automated scheduling for background jobs, history pruning, session management, and non-blocking startup with readiness checks.
-   **Zero-Config Startup**: Automatic S3 bucket creation and test user provisioning in non-production environments.

## Technology Stack

-   **Runtime**: Node.js (v24+)
-   **Framework**: Express.js
-   **Language**: TypeScript
-   **Storage Backend**: AWS S3 (or S3-compatible storage like MinIO)
-   **Authentication**: Firebase Authentication (token verification only)
-   **Testing**: `vitest`
-   **Code Quality**: ESLint, Prettier
-   **Observability**: BetterStack (Logtail)

## Project Architecture (Simplified)

The project follows an MVC pattern, with services containing business logic and models defining data structures. Key design patterns include:
-   **Smart Sync Model**: Handles property-level synchronization for both client-mutable (timestamp-based) and server-managed fields (direct updates).
-   **Stateless History**: Mutation ledgers are processed and discarded from memory.
-   **Lazy Loading**: User data is loaded selectively on-demand.
-   **Sequential Versioning**: ETags follow a `v{number}` format for API versioning.

## Getting Started

To get a local copy up and running, follow these simple steps.

### Prerequisites

Ensure you have the following installed:
-   Node.js: v24.x
-   npm: >=11
-   Docker: For running local dependencies (MinIO, Firebase Emulator).

### Installation

```bash
npm install
```

### Running in Development Mode

Starts the server with hot-reloading:

```bash
npm run dev
```

### Building for Production

Transpiles TypeScript to JavaScript and copies locales:

```bash
npm run build
```

### Running in Production Mode

Starts the server from the built files in the `dist` folder:

```bash
npm run start
```

### Running Tests

This project uses `vitest` for testing:

```bash
npm run test
```

### Local Development Environment

Start local MinIO and Firebase Emulator instances using Docker:

```bash
npm run minio:start
npm run firebase:start
```

To stop MinIO:

```bash
npm run minio:stop
```

## Localization

We support the localization of email messages generated by this API, based on the UI language selected by the user. The translation process is handled on [Crowdin](https://crowdin.com/project/sws2apps-api). To help with localization, please read the [TRANSLATION](./TRANSLATION.md) guide.

## Contributing

Please refer to the [CONTRIBUTING.md](./CONTRIBUTING.md) for contribution guidelines.
